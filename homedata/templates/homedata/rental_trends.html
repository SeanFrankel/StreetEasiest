{% extends "base_page.html" %}
{% load static wagtailcore_tags wagtailimages_tags %}

{% block content %}
  {% block breadcrumbs %}
    {% include "navigation/breadcrumbs.html" %}
  {% endblock %}

  <div class="site-padding site-container py-8">

    <!-- HOW TO USE SECTION -->
    {% if page.how_to_use %}
      <div class="rich-text mb-8">
        <h2 class="font-serif4 font-bold text-3xl mb-4">How to Use</h2>
        {{ page.how_to_use|richtext }}
      </div>
    {% endif %}

    <!-- PAGE TITLE -->
    <h1 class="font-serif4 font-bold text-4xl lg:text-7xl mb-4">Historical Rental Trends</h1>

    <!-- OPTIONAL INTRO TEXT -->
    {% if page.intro %}
      <div class="rich-text mb-4">
        {{ page.intro|richtext }}
      </div>
    {% endif %}

    <!-- MAIN LAYOUT: LEFT SIDEBAR & RIGHT CHART DISPLAY -->
    <!-- The flex container has a minimum height so that the chart extends to match the sidebar -->
    <div class="flex flex-row gap-8 mb-8 min-h-[600px]">

      <!-- LEFT SIDEBAR (Fixed width: 256px) with Chart Controls -->
      <div class="w-64 bg-gray-100 p-4 rounded shadow">
        <!-- Data Type Selection -->
        <div class="mb-4" id="dataTypeContainer">
          <label class="block font-semibold mb-1">Select Data Types:</label>
          <div>
            <input type="checkbox" id="dt_median" value="median" checked class="form-checkbox">
            <label for="dt_median" class="ml-2">Median Asking Rent</label>
          </div>
          <div>
            <input type="checkbox" id="dt_inventory" value="inventory" class="form-checkbox">
            <label for="dt_inventory" class="ml-2">Rental Inventory</label>
          </div>
        </div>

        <!-- Bedroom Type Selection -->
        <div class="mb-4" id="bedroomContainer">
          <label class="block font-semibold mb-1">Select Bedroom Types:</label>
          <div>
            <input type="checkbox" id="bed_All" value="All" checked class="form-checkbox">
            <label for="bed_All" class="ml-2">All Bedrooms</label>
          </div>
          <div>
            <input type="checkbox" id="bed_Studio" value="Studio" class="form-checkbox">
            <label for="bed_Studio" class="ml-2">Studio</label>
          </div>
          <div>
            <input type="checkbox" id="bed_OneBd" value="OneBd" class="form-checkbox">
            <label for="bed_OneBd" class="ml-2">One Bedroom</label>
          </div>
          <div>
            <input type="checkbox" id="bed_TwoBd" value="TwoBd" class="form-checkbox">
            <label for="bed_TwoBd" class="ml-2">Two Bedroom</label>
          </div>
          <div>
            <input type="checkbox" id="bed_ThreePlusBd" value="ThreePlusBd" class="form-checkbox">
            <label for="bed_ThreePlusBd" class="ml-2">Three+ Bedrooms</label>
          </div>
        </div>

        <!-- Neighborhood Selection is now in a separate file -->
        {% include "components/neighborhoods.html" %}

        <!-- Chart Controls Title -->
        <div class="mb-2">
          <label class="block font-semibold">Chart Controls</label>
        </div>

        <!-- Secondary Axis Toggle -->
        <div class="mb-4" id="secondaryAxisToggleContainer">
          <input type="checkbox" id="toggleInventorySecondary" class="form-checkbox">
          <label for="toggleInventorySecondary" class="ml-2">Plot Rental Inventory on Secondary Y Axis</label>
        </div>

        <!-- Seasonality Adjustment Toggle -->
        <div class="mb-4">
          <label class="block font-semibold mb-1">Data Display Options:</label>
          <div>
            <input type="checkbox" id="rawDataCheckbox" value="raw" checked class="form-checkbox">
            <label for="rawDataCheckbox" class="ml-2">Display Raw Data Only</label>
          </div>
          <div>
            <input type="checkbox" id="seasonalCheckbox" value="seasonal" class="form-checkbox">
            <label for="seasonalCheckbox" class="ml-2">Show Only Seasonally Adjusted Data</label>
          </div>
          <div>
            <input type="checkbox" id="showBothCheckbox" value="both" class="form-checkbox">
            <label for="showBothCheckbox" class="ml-2">Show Both Raw and Seasonally Adjusted Data</label>
          </div>
        </div>

        <!-- Deselect All / Reset Defaults Button -->
        <div class="mb-4">
          {% include "components/button.html" with title="Deselect All" url="#" extra_class="reset-filters" id="resetFilters" %}
        </div>
      </div>

      <!-- RIGHT COLUMN (Remaining width): CHART CANVAS CONTAINER -->
      <div class="flex-1">
        <div class="relative mx-auto h-full" style="max-width: 900px;">
          <canvas id="rentChart" class="h-full"></canvas>
          <div id="loadingIndicator" class="absolute inset-0 flex justify-center items-center bg-white bg-opacity-75 hidden">
            <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
          </div>
        </div>
      </div>

    </div> <!-- End of main row -->

  {% include_block page.body %}

  <!-- DATA FAQS SECTION -->
  {% if page.data_faqs %}
    <div class="rich-text mt-8">
      <h2 class="font-serif4 font-bold text-3xl mb-4">Data FAQs</h2>
      {{ page.data_faqs|richtext }}
    </div>
  {% endif %}

  <!-- Include Chart.js and chart rendering JS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // FILTER FUNCTIONALITY (Neighborhood Search)
    document.getElementById('checkboxFilter').addEventListener('input', function() {
      const filterValue = this.value.toLowerCase();
      const container = document.getElementById('checkboxContainer');
      const checkboxDivs = container.getElementsByTagName('div');
      for (let i = 0; i < checkboxDivs.length; i++) {
        const labelText = checkboxDivs[i].querySelector('label').textContent.toLowerCase();
        checkboxDivs[i].style.display = (labelText.indexOf(filterValue) > -1) ? '' : 'none';
      }
    });

    // RESET / DESELECT ALL FUNCTION
    function resetFilters(e) {
      e.preventDefault();
      document.getElementById('dt_median').checked = true;
      document.getElementById('dt_inventory').checked = false;
      document.getElementById('bed_All').checked = true;
      document.getElementById('bed_Studio').checked = false;
      document.getElementById('bed_OneBd').checked = false;
      document.getElementById('bed_TwoBd').checked = false;
      document.getElementById('bed_ThreePlusBd').checked = false;
      const neighborhoodCheckboxes = document.querySelectorAll("#checkboxContainer input[type='checkbox']");
      neighborhoodCheckboxes.forEach(cb => { cb.checked = (cb.id === "nb_Manhattan"); });
      document.getElementById('toggleInventorySecondary').checked = false;
      document.getElementById('checkboxFilter').value = "";
      fetchAndRenderChart();
    }

    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById('resetFilters').addEventListener('click', resetFilters);
    });

    // Initialization code
    document.addEventListener("DOMContentLoaded", function() {
      console.log("DOM Content Loaded");
      
      // Set default selections if none are made
      const defaultSelections = () => {
        if (!document.querySelector("#dataTypeContainer input:checked")) {
          document.querySelector("#dataTypeContainer input[value='median']").checked = true;
        }
        if (!document.querySelector("#bedroomContainer input:checked")) {
          document.querySelector("#bedroomContainer input[value='All']").checked = true;
        }
        if (!document.querySelector("#checkboxContainer input:checked")) {
          document.querySelector("#checkboxContainer input[value='Manhattan']").checked = true;
        }
        // Ensure raw data checkbox is checked by default
        document.getElementById('rawDataCheckbox').checked = true;
        document.getElementById('seasonalCheckbox').checked = false;
        document.getElementById('showBothCheckbox').checked = false;
      };

      // Set default selections
      defaultSelections();

      // Add event listeners
      const addListeners = () => {
        document.getElementById('rawDataCheckbox').addEventListener('change', function() {
          if (this.checked) {
            document.getElementById('seasonalCheckbox').checked = false;
            document.getElementById('showBothCheckbox').checked = false;
          }
          updateChart();
        });

        document.getElementById('seasonalCheckbox').addEventListener('change', function() {
          if (this.checked) {
            document.getElementById('rawDataCheckbox').checked = false;
            document.getElementById('showBothCheckbox').checked = false;
          }
          updateChart();
        });

        document.getElementById('showBothCheckbox').addEventListener('change', function() {
          if (this.checked) {
            document.getElementById('rawDataCheckbox').checked = false;
            document.getElementById('seasonalCheckbox').checked = false;
          }
          updateChart();
        });

        // Add listeners for other controls
        document.getElementById('checkboxContainer').addEventListener('change', updateChart);
        document.getElementById('dataTypeContainer').addEventListener('change', updateChart);
        document.getElementById('bedroomContainer').addEventListener('change', updateChart);
      };

      // Add all event listeners
      addListeners();

      // Add listener for the secondary axis toggle
      document.getElementById('toggleInventorySecondary').addEventListener('change', updateChart);

      // Initial chart render
      console.log("Triggering initial chart update");
      updateChart();
    });

    // Update Chart function
    function updateChart() {
      console.log("updateChart called");
      const loadingIndicator = document.getElementById('loadingIndicator');
      loadingIndicator.classList.remove('hidden');

      // Get selected data types
      let dataTypeCheckboxes = document.querySelectorAll("#dataTypeContainer input[type='checkbox']:checked");
      let selectedDataTypes = Array.from(dataTypeCheckboxes).map(cb => cb.value);
      console.log("Selected data types:", selectedDataTypes);

      // Get selected bedroom types
      let bedroomCheckboxes = document.querySelectorAll("#bedroomContainer input[type='checkbox']:checked");
      let selectedBedroomTypes = Array.from(bedroomCheckboxes).map(cb => cb.value);
      console.log("Selected bedroom types:", selectedBedroomTypes);

      // Get selected neighborhoods
      let neighborhoodCheckboxes = document.querySelectorAll("#checkboxContainer input[type='checkbox']:checked");
      let selectedNeighborhoods = Array.from(neighborhoodCheckboxes).map(cb => cb.value);
      console.log("Selected neighborhoods:", selectedNeighborhoods);

      // Get seasonality state
      const rawDataCheckbox = document.getElementById('rawDataCheckbox');
      const seasonalCheckbox = document.getElementById('seasonalCheckbox');
      const showBothCheckbox = document.getElementById('showBothCheckbox');
      const showSeasonalOnly = seasonalCheckbox.checked;
      const showBoth = showBothCheckbox.checked;
      const useSeasonalData = showSeasonalOnly || showBoth;

      console.log("Seasonality state:", { showSeasonalOnly, showBoth, useSeasonalData });

      if (selectedDataTypes.length === 0 || selectedBedroomTypes.length === 0 || selectedNeighborhoods.length === 0) {
        console.log("No selections made in required fields");
        if (window.rentChartInstance) { window.rentChartInstance.destroy(); }
        loadingIndicator.classList.add('hidden');
        return;
      }

      let requests = [];
      selectedDataTypes.forEach(dt => {
        selectedBedroomTypes.forEach(bed => {
          selectedNeighborhoods.forEach(nb => {
            const url = `/homedata/rental-data-json/?data=${dt}&bedrooms=${bed}&area=${nb}&seasonal=${useSeasonalData}`;
            console.log("Fetching URL:", url);
            requests.push(
              fetch(url)
                .then(response => response.json())
                .then(jsonData => {
                  console.log("Received data for:", dt, bed, nb, jsonData);
                  return { dataType: dt, bedroom: bed, neighborhood: nb, jsonData: jsonData };
                })
            );
          });
        });
      });

      Promise.all(requests)
        .then(responses => {
          console.log("All responses received:", responses);
          let datasets = [];
          let labels = null;
          const useSecondaryAxis = document.getElementById('toggleInventorySecondary').checked;

          responses.forEach(response => {
            Object.entries(response.jsonData).forEach(([area, areaData]) => {
              const borough = areaData.Borough;
              const monthlyData = areaData.monthly;
              const isInventory = response.dataType === 'inventory';

              if (!monthlyData) {
                console.warn(`No monthly data for ${area}`);
                return;
              }

              // Default to raw data
              if (!showSeasonalOnly && monthlyData.raw) {
                const dates = Object.keys(monthlyData.raw).sort();
                const values = dates.map(date => monthlyData.raw[date]);
                const color = getRandomColor();
                datasets.push({
                  label: `${area} (${borough}) - Raw ${isInventory ? 'Inventory' : 'Rent'}`,
                  data: values,
                  borderColor: color,
                  backgroundColor: color,
                  fill: false,
                  yAxisID: useSecondaryAxis && isInventory ? 'y1' : 'y'
                });
                if (!labels) labels = dates;
              }

              // Add seasonal data if requested
              if ((showSeasonalOnly || showBoth) && monthlyData.adjusted) {
                const dates = Object.keys(monthlyData.adjusted).sort();
                const values = dates.map(date => monthlyData.adjusted[date]);
                const color = getRandomColor();
                datasets.push({
                  label: `${area} (${borough}) - Seasonally Adjusted ${isInventory ? 'Inventory' : 'Rent'}`,
                  data: values,
                  borderColor: color,
                  backgroundColor: color,
                  fill: false,
                  yAxisID: useSecondaryAxis && isInventory ? 'y1' : 'y'
                });
                if (!labels) labels = dates;
              }
            });
          });

          console.log("Created datasets:", datasets);
          
          // Create or update chart
          const ctx = document.getElementById('rentChart').getContext('2d');
          if (window.rentChartInstance) {
            window.rentChartInstance.destroy();
          }

          if (datasets.length > 0 && labels) {
            const hasInventoryData = datasets.some(ds => ds.label.includes('Inventory'));
            
            window.rentChartInstance = new Chart(ctx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: datasets
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                  mode: 'index',
                  intersect: false
                },
                plugins: {
                  tooltip: {
                    mode: 'index',
                    intersect: false
                  },
                  legend: {
                    position: 'top'
                  }
                },
                scales: {
                  y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: false,
                    title: {
                      display: true,
                      text: 'Rent (USD)'
                    }
                  },
                  ...(useSecondaryAxis && hasInventoryData ? {
                    y1: {
                      type: 'linear',
                      display: true,
                      position: 'right',
                      beginAtZero: false,
                      grid: {
                        drawOnChartArea: false
                      },
                      title: {
                        display: true,
                        text: 'Inventory Count'
                      }
                    }
                  } : {})
                }
              }
            });
            console.log("Chart created successfully");
          } else {
            console.warn("No valid datasets to display");
          }
        })
        .catch(error => {
          console.error("Error fetching data:", error);
          alert("An error occurred while fetching the rental data.");
        })
        .finally(() => {
          loadingIndicator.classList.add('hidden');
        });
    }

    // Helper function for random colors
    function getRandomColor() {
      const colors = [
        'rgba(75, 192, 192, 1)',
        'rgba(255, 99, 132, 1)',
        'rgba(54, 162, 235, 1)',
        'rgba(255, 206, 86, 1)',
        'rgba(153, 102, 255, 1)',
        'rgba(255, 159, 64, 1)',
        'rgba(0, 128, 0, 1)',
        'rgba(128, 0, 128, 1)'
      ];
      return colors[Math.floor(Math.random() * colors.length)];
    }
  </script>
{% endblock %}
