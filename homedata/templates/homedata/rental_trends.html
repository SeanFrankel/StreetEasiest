{% extends "base_page.html" %}
{% load static wagtailcore_tags wagtailimages_tags %}

{% block content %}
  {% block breadcrumbs %}
    {% include "navigation/breadcrumbs.html" %}
  {% endblock %}

  <div class="site-padding site-container py-8">

    <!-- HOW TO USE SECTION -->
    {% if page.how_to_use %}
      <div class="rich-text mb-8">
        <h2 class="font-serif4 font-bold text-3xl mb-4">How to Use</h2>
        {{ page.how_to_use|richtext }}
      </div>
    {% endif %}

    <!-- PAGE TITLE -->
    <h1 class="font-serif4 font-bold text-4xl lg:text-7xl mb-4">Historical Rental Trends</h1>

    <!-- OPTIONAL INTRO TEXT -->
    {% if page.intro %}
      <div class="rich-text mb-4">
        {{ page.intro|richtext }}
      </div>
    {% endif %}

    <!-- MAIN LAYOUT: LEFT SIDEBAR & RIGHT CHART DISPLAY -->
    <!-- The flex container has a minimum height so that the chart extends to match the sidebar -->
    <div class="flex flex-row gap-8 mb-8 min-h-[600px]">

      <!-- LEFT SIDEBAR (Fixed width: 256px) with Chart Controls -->
      <div class="w-64 bg-gray-100 p-4 rounded shadow">

        
        <!-- Data Type Selection -->
        <div class="mb-4" id="dataTypeContainer">
          <label class="block font-semibold mb-1">Select Data Types:</label>
          <div>
            <input type="checkbox" id="dt_median" value="median" checked class="form-checkbox">
            <label for="dt_median" class="ml-2">Median Asking Rent</label>
          </div>
          <div>
            <input type="checkbox" id="dt_inventory" value="inventory" class="form-checkbox">
            <label for="dt_inventory" class="ml-2">Rental Inventory</label>
          </div>
        </div>

        <!-- Bedroom Type Selection -->
        <div class="mb-4" id="bedroomContainer">
          <label class="block font-semibold mb-1">Select Bedroom Types:</label>
          <div>
            <input type="checkbox" id="bed_All" value="All" checked class="form-checkbox">
            <label for="bed_All" class="ml-2">All Bedrooms</label>
          </div>
          <div>
            <input type="checkbox" id="bed_Studio" value="Studio" class="form-checkbox">
            <label for="bed_Studio" class="ml-2">Studio</label>
          </div>
          <div>
            <input type="checkbox" id="bed_OneBd" value="OneBd" class="form-checkbox">
            <label for="bed_OneBd" class="ml-2">One Bedroom</label>
          </div>
          <div>
            <input type="checkbox" id="bed_TwoBd" value="TwoBd" class="form-checkbox">
            <label for="bed_TwoBd" class="ml-2">Two Bedroom</label>
          </div>
          <div>
            <input type="checkbox" id="bed_ThreePlusBd" value="ThreePlusBd" class="form-checkbox">
            <label for="bed_ThreePlusBd" class="ml-2">Three+ Bedrooms</label>
          </div>
        </div>

        <!-- Neighborhood Selection is now in a separate file -->
        {% include "components/neighborhoods.html" %}

        <!-- Chart Controls Title -->
        <div class="mb-2">
          <label class="block font-semibold">Chart Controls</label>
        </div>

        <!-- Secondary Axis Toggle -->
        <div class="mb-4" id="secondaryAxisToggleContainer">
          <input type="checkbox" id="toggleInventorySecondary" class="form-checkbox">
          <label for="toggleInventorySecondary" class="ml-2">Plot Rental Inventory on Secondary Y Axis</label>
        </div>

        <!-- Seasonality Adjustment Toggle -->
        <div class="mb-4">
          <label class="block font-semibold mb-1">Data Display Options:</label>
          <div>
            <input type="checkbox" id="rawDataCheckbox" value="raw" checked class="form-checkbox">
            <label for="rawDataCheckbox" class="ml-2">Display Raw Data Only</label>
          </div>
          <div>
            <input type="checkbox" id="seasonalCheckbox" value="seasonal" class="form-checkbox">
            <label for="seasonalCheckbox" class="ml-2">Show Only Seasonally Adjusted Data</label>
          </div>
          <div>
            <input type="checkbox" id="showBothCheckbox" value="both" class="form-checkbox">
            <label for="showBothCheckbox" class="ml-2">Show Both Raw and Seasonally Adjusted Data</label>
          </div>
        </div>

        <!-- Deselect All / Reset Defaults Button -->
        <div class="mb-4">
          {% include "components/button.html" with title="Deselect All" url="#" extra_class="reset-filters" id="resetFilters" %}
        </div>
      </div>

      <!-- RIGHT COLUMN (Remaining width): CHART CANVAS CONTAINER -->
      <div class="flex-1">
        <div class="relative mx-auto h-full" style="max-width: 900px;">
          <canvas id="rentChart" class="h-full"></canvas>
          <div id="loadingIndicator" class="absolute inset-0 flex justify-center items-center bg-white bg-opacity-75 hidden">
            <div class="animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
          </div>
        </div>
      </div>

    </div> <!-- End of main row -->

  {% include_block page.body %}

  <!-- DATA FAQS SECTION -->
  {% if page.data_faqs %}
    <div class="rich-text mt-8">
      <h2 class="font-serif4 font-bold text-3xl mb-4">Data FAQs</h2>
      {{ page.data_faqs|richtext }}
    </div>
  {% endif %}

  <!-- Include Chart.js and chart rendering JS -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // FILTER FUNCTIONALITY (Neighborhood Search)
    document.getElementById('checkboxFilter').addEventListener('input', function() {
      const filterValue = this.value.toLowerCase();
      const container = document.getElementById('checkboxContainer');
      const checkboxDivs = container.getElementsByTagName('div');
      for (let i = 0; i < checkboxDivs.length; i++) {
        const labelText = checkboxDivs[i].querySelector('label').textContent.toLowerCase();
        checkboxDivs[i].style.display = (labelText.indexOf(filterValue) > -1) ? '' : 'none';
      }
    });
  
    // Define a color palette to keep colors consistent
    const colorPalette = {
      'Manhattan': '#4e79a7',
      'Brooklyn': '#f28e2c',
      'Queens': '#e15759',
      'Bronx': '#76b7b2',
      'Staten Island': '#59a14f',
      'All': '#af7aa1',
      'median': '#4e79a7',
      'inventory': '#f28e2c',
      'Studio': '#e15759',
      'OneBd': '#76b7b2',
      'TwoBd': '#59a14f',
      'ThreePlusBd': '#af7aa1'
    };
  
    // Color cache to ensure consistent colors for the same data series
    const colorCache = {};
    
    // Generate a deterministic color based on key parameters
    function getConsistentColor(dataType, bedroom, neighborhood) {
      const key = `${dataType}_${bedroom}_${neighborhood}`;
      
      if (colorCache[key]) {
        return colorCache[key];
      }
      
      // Use color from palette if available, otherwise generate a deterministic color
      if (colorPalette[neighborhood]) {
        const baseColor = colorPalette[neighborhood];
        // Slight variations for bedroom types
        if (bedroom !== 'All') {
          const hslColor = hexToHSL(baseColor);
          // Adjust lightness based on data type
          if (dataType === 'inventory') {
            hslColor.l = Math.min(hslColor.l + 15, 90);
          }
          // Adjust hue based on bedroom type
          if (bedroom === 'Studio') hslColor.h = (hslColor.h + 10) % 360;
          if (bedroom === 'OneBd') hslColor.h = (hslColor.h + 20) % 360;
          if (bedroom === 'TwoBd') hslColor.h = (hslColor.h + 30) % 360;
          if (bedroom === 'ThreePlusBd') hslColor.h = (hslColor.h + 40) % 360;
          
          colorCache[key] = hslToHex(hslColor);
        } else {
          colorCache[key] = baseColor;
        }
      } else {
        // Generate a deterministic color from the key
        let hash = 0;
        for (let i = 0; i < key.length; i++) {
          hash = key.charCodeAt(i) + ((hash << 5) - hash);
        }
        
        const h = Math.abs(hash) % 360;
        const s = 70;
        const l = 60;
        
        colorCache[key] = hslToHex({h, s, l});
      }
      
      return colorCache[key];
    }
    
    // Helper function to convert hex to HSL
    function hexToHSL(hex) {
      // Remove the # if present
      hex = hex.replace(/^#/, '');
      
      // Parse the hex values
      let r = parseInt(hex.substr(0, 2), 16) / 255;
      let g = parseInt(hex.substr(2, 2), 16) / 255;
      let b = parseInt(hex.substr(4, 2), 16) / 255;
      
      // Find the min and max values
      let max = Math.max(r, g, b);
      let min = Math.min(r, g, b);
      
      // Calculate lightness
      let l = (max + min) / 2;
      
      let h, s;
      
      if (max === min) {
        // Achromatic
        h = s = 0;
      } else {
        // Calculate saturation
        s = l > 0.5 ? (max - min) / (2 - max - min) : (max - min) / (max + min);
        
        // Calculate hue
        switch (max) {
          case r: h = (g - b) / (max - min) + (g < b ? 6 : 0); break;
          case g: h = (b - r) / (max - min) + 2; break;
          case b: h = (r - g) / (max - min) + 4; break;
        }
        h = Math.round(h * 60);
      }
      
      s = Math.round(s * 100);
      l = Math.round(l * 100);
      
      return { h, s, l };
    }
    
    // Helper function to convert HSL to hex
    function hslToHex({ h, s, l }) {
      s /= 100;
      l /= 100;
      
      const c = (1 - Math.abs(2 * l - 1)) * s;
      const x = c * (1 - Math.abs((h / 60) % 2 - 1));
      const m = l - c / 2;
      
      let r, g, b;
      
      if (h >= 0 && h < 60) {
        [r, g, b] = [c, x, 0];
      } else if (h >= 60 && h < 120) {
        [r, g, b] = [x, c, 0];
      } else if (h >= 120 && h < 180) {
        [r, g, b] = [0, c, x];
      } else if (h >= 180 && h < 240) {
        [r, g, b] = [0, x, c];
      } else if (h >= 240 && h < 300) {
        [r, g, b] = [x, 0, c];
      } else {
        [r, g, b] = [c, 0, x];
      }
      
      r = Math.round((r + m) * 255).toString(16).padStart(2, '0');
      g = Math.round((g + m) * 255).toString(16).padStart(2, '0');
      b = Math.round((b + m) * 255).toString(16).padStart(2, '0');
      
      return `#${r}${g}${b}`;
    }
  
    // RESET / DESELECT ALL FUNCTION
    function resetFilters(e) {
      e.preventDefault();
      document.getElementById('dt_median').checked = true;
      document.getElementById('dt_inventory').checked = false;
      document.getElementById('bed_All').checked = true;
      document.getElementById('bed_Studio').checked = false;
      document.getElementById('bed_OneBd').checked = false;
      document.getElementById('bed_TwoBd').checked = false;
      document.getElementById('bed_ThreePlusBd').checked = false;
      const neighborhoodCheckboxes = document.querySelectorAll("#checkboxContainer input[type='checkbox']");
      neighborhoodCheckboxes.forEach(cb => { cb.checked = (cb.id === "nb_Manhattan"); });
      document.getElementById('toggleInventorySecondary').checked = false;
      document.getElementById('checkboxFilter').value = "";
      fetchAndRenderChart();
    }
  
    document.addEventListener("DOMContentLoaded", function() {
      document.getElementById('resetFilters').addEventListener('click', resetFilters);
    });
  
    // Initialization code
    document.addEventListener("DOMContentLoaded", function() {
      console.log("DOM Content Loaded");
      
      // Set default selections if none are made
      const defaultSelections = () => {
        if (!document.querySelector("#dataTypeContainer input:checked")) {
          document.querySelector("#dataTypeContainer input[value='median']").checked = true;
        }
        if (!document.querySelector("#bedroomContainer input:checked")) {
          document.querySelector("#bedroomContainer input[value='All']").checked = true;
        }
        if (!document.querySelector("#checkboxContainer input:checked")) {
          document.querySelector("#checkboxContainer input[value='Manhattan']").checked = true;
        }
        // Ensure raw data checkbox is checked by default
        document.getElementById('rawDataCheckbox').checked = true;
        document.getElementById('seasonalCheckbox').checked = false;
        document.getElementById('showBothCheckbox').checked = false;
      };
  
      // Set default selections
      defaultSelections();
  
      // Add event listeners
      const addListeners = () => {
        document.getElementById('rawDataCheckbox').addEventListener('change', function() {
          if (this.checked) {
            document.getElementById('seasonalCheckbox').checked = false;
            document.getElementById('showBothCheckbox').checked = false;
          }
          updateChart();
        });
  
        document.getElementById('seasonalCheckbox').addEventListener('change', function() {
          if (this.checked) {
            document.getElementById('rawDataCheckbox').checked = false;
            document.getElementById('showBothCheckbox').checked = false;
          }
          updateChart();
        });
  
        document.getElementById('showBothCheckbox').addEventListener('change', function() {
          if (this.checked) {
            document.getElementById('rawDataCheckbox').checked = false;
            document.getElementById('seasonalCheckbox').checked = false;
          }
          updateChart();
        });
  
        // Add listeners for other controls
        document.getElementById('checkboxContainer').addEventListener('change', updateChart);
        document.getElementById('dataTypeContainer').addEventListener('change', updateChart);
        document.getElementById('bedroomContainer').addEventListener('change', updateChart);
      };
  
      // Add all event listeners
      addListeners();
  
      // Add listener for the secondary axis toggle
      document.getElementById('toggleInventorySecondary').addEventListener('change', updateChart);
  
      // Initial chart render
      console.log("Triggering initial chart update");
      updateChart();
    });
  
    // Update Chart function
    function updateChart() {
      console.log("updateChart called");
      const loadingIndicator = document.getElementById('loadingIndicator');
      loadingIndicator.classList.remove('hidden');
  
      // Get selected data types
      let dataTypeCheckboxes = document.querySelectorAll("#dataTypeContainer input[type='checkbox']:checked");
      let selectedDataTypes = Array.from(dataTypeCheckboxes).map(cb => cb.value);
      console.log("Selected data types:", selectedDataTypes);
  
      // Get selected bedroom types
      let bedroomCheckboxes = document.querySelectorAll("#bedroomContainer input[type='checkbox']:checked");
      let selectedBedroomTypes = Array.from(bedroomCheckboxes).map(cb => cb.value);
      console.log("Selected bedroom types:", selectedBedroomTypes);
  
      // Get selected neighborhoods
      let neighborhoodCheckboxes = document.querySelectorAll("#checkboxContainer input[type='checkbox']:checked");
      let selectedNeighborhoods = Array.from(neighborhoodCheckboxes).map(cb => cb.value);
      console.log("Selected neighborhoods:", selectedNeighborhoods);
  
      // Get seasonality state
      const rawDataCheckbox = document.getElementById('rawDataCheckbox');
      const seasonalCheckbox = document.getElementById('seasonalCheckbox');
      const showBothCheckbox = document.getElementById('showBothCheckbox');
      const showSeasonalOnly = seasonalCheckbox.checked;
      const showBoth = showBothCheckbox.checked;
      const useSeasonalData = showSeasonalOnly || showBoth;
  
      console.log("Seasonality state:", { showSeasonalOnly, showBoth, useSeasonalData });
  
      if (selectedDataTypes.length === 0 || selectedBedroomTypes.length === 0 || selectedNeighborhoods.length === 0) {
        console.log("No selections made in required fields");
        if (window.rentChartInstance) { window.rentChartInstance.destroy(); }
        loadingIndicator.classList.add('hidden');
        return;
      }
  
      let requests = [];
      selectedDataTypes.forEach(dt => {
        selectedBedroomTypes.forEach(bed => {
          selectedNeighborhoods.forEach(nb => {
            const url = `/homedata/rental-data-json/?data=${dt}&bedrooms=${bed}&area=${nb}&seasonal=${useSeasonalData}`;
            console.log("Fetching URL:", url);
            requests.push(
              fetch(url)
                .then(response => response.json())
                .then(jsonData => {
                  console.log("Received data for:", dt, bed, nb, jsonData);
                  return { dataType: dt, bedroom: bed, neighborhood: nb, jsonData: jsonData };
                })
            );
          });
        });
      });
  
      Promise.all(requests)
        .then(responses => {
          console.log("All responses received:", responses);
          let datasets = [];
          let labels = null;
          const useSecondaryAxis = document.getElementById('toggleInventorySecondary').checked;
  
          responses.forEach(response => {
            Object.entries(response.jsonData).forEach(([area, areaData]) => {
              const borough = areaData.Borough || "NYC";  // Default to NYC if borough is undefined
              const nbName = area || borough; // Use area name or fall back to borough
              const monthlyData = areaData.monthly;
              const isInventory = response.dataType === 'inventory';
  
              if (!monthlyData) {
                console.warn(`No monthly data for ${nbName}`);
                return;
              }
  
              // Default to raw data
              if (!showSeasonalOnly && monthlyData.raw) {
                const dates = Object.keys(monthlyData.raw).sort();
                const values = dates.map(date => monthlyData.raw[date]);
                
                // Get consistent color based on data parameters
                const color = getConsistentColor(response.dataType, response.bedroom, nbName);
                
                datasets.push({
                  label: `${nbName} - Raw ${isInventory ? 'Inventory' : 'Rent'}`,
                  data: values,
                  borderColor: color,
                  backgroundColor: color,
                  fill: false,
                  yAxisID: useSecondaryAxis && isInventory ? 'y1' : 'y'
                });
                if (!labels) labels = dates;
              }
  
              // Add seasonal data if requested
              if ((showSeasonalOnly || showBoth) && monthlyData.adjusted) {
                const dates = Object.keys(monthlyData.adjusted).sort();
                const values = dates.map(date => monthlyData.adjusted[date]);
                
                // Get consistent color with slight variation for seasonal data
                let color = getConsistentColor(response.dataType, response.bedroom, nbName);
                // Make seasonal data a darker version of the same color
                const hslColor = hexToHSL(color);
                hslColor.l = Math.max(hslColor.l - 15, 30);
                color = hslToHex(hslColor);
                
                datasets.push({
                  label: `${nbName} - Seasonally Adjusted ${isInventory ? 'Inventory' : 'Rent'}`,
                  data: values,
                  borderColor: color,
                  backgroundColor: color,
                  fill: false,
                  yAxisID: useSecondaryAxis && isInventory ? 'y1' : 'y'
                });
                if (!labels) labels = dates;
              }
            });
          });
  
          console.log("Created datasets:", datasets);
          
          // Create or update chart
          const ctx = document.getElementById('rentChart').getContext('2d');
          if (window.rentChartInstance) {
            window.rentChartInstance.destroy();
          }
  
          if (datasets.length > 0 && labels) {
            const hasInventoryData = datasets.some(ds => ds.label.includes('Inventory'));
            
            window.rentChartInstance = new Chart(ctx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: datasets
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                  mode: 'index',
                  intersect: false
                },
                plugins: {
                  tooltip: {
                    mode: 'index',
                    intersect: false
                  },
                  legend: {
                    position: 'top'
                  },
                  title: {
                    display: true,
                    text: 'NYC Rental Trends',
                    font: {
                      size: 16,
                      weight: 'bold'
                    }
                  }
                },
                scales: {
                  y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    beginAtZero: false,
                    title: {
                      display: true,
                      text: 'Rent (USD)'
                    }
                  },
                  ...(useSecondaryAxis && hasInventoryData ? {
                    y1: {
                      type: 'linear',
                      display: true,
                      position: 'right',
                      beginAtZero: false,
                      grid: {
                        drawOnChartArea: false
                      },
                      title: {
                        display: true,
                        text: 'Inventory Count'
                      }
                    }
                  } : {})
                }
              }
            });
            console.log("Chart created successfully");
          } else {
            console.warn("No valid datasets to display");
          }
  
          loadingIndicator.classList.add('hidden');
        })
        .catch(error => {
          console.error("Error fetching data:", error);
          loadingIndicator.classList.add('hidden');
        });
    }
  
    // Replacement for the missing getRandomColor function (no longer used)
    function getRandomColor() {
      return `#${Math.floor(Math.random()*16777215).toString(16).padStart(6, '0')}`;
    }
  </script>
{% endblock %}
