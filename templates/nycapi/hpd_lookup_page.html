{% extends "base_page.html" %}
{% load wagtailcore_tags wagtailimages_tags static %}

{% block content %}
<div class="site-padding site-container py-8">
  <h1 class="font-serif4 font-bold text-4xl lg:text-5xl mb-4">{{ page.header }}</h1>
  
  {% if page.instructions %}
    <div class="rich-text mb-6">
      {{ page.instructions|richtext }}
    </div>
  {% endif %}
  
  <div class="bg-gray-100 p-6 rounded-lg shadow-md mb-8">
    <h2 class="font-serif4 font-bold text-2xl mb-4">Search HPD Database</h2>
    <form id="hpd-lookup-form" class="flex flex-col md:flex-row gap-4">
      <div class="flex-grow">
        <label for="address" class="block mb-1 font-medium">Street Address</label>
        <input type="text" id="address" name="address" 
               placeholder="e.g., 123 Main St" required
               class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      <div class="md:w-1/4">
        <label for="zip-code" class="block mb-1 font-medium">ZIP Code</label>
        <input type="text" id="zip-code" name="zip_code" 
               placeholder="e.g., 10001" required
               class="w-full px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" />
      </div>
      <div class="md:self-end">
        <button type="submit" 
                class="bg-white border border-blue-700 text-blue-900 px-6 py-2 rounded hover:bg-blue-50 transition duration-200">
          Search HPD
        </button>
      </div>
    </form>
  </div>
  
  <div id="loading-indicator" class="hidden text-center py-8">
    <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div>
    <p class="mt-2">Fetching data from HPD Online...</p>
    <p class="text-sm text-gray-500">This process requires automated browsing and may take 15-20 seconds.</p>
  </div>
  
  <div id="results-container" class="hidden">
    <div id="property-info" class="mb-8 bg-white p-6 rounded-lg shadow-md">
      <h2 class="font-serif4 font-bold text-2xl mb-4 border-b pb-2">Property Information</h2>
      <div id="property-details" class="grid grid-cols-2 gap-4">
        <!-- Property info will be populated here -->
      </div>
    </div>
    
    <div id="violations-container" class="mb-8">
      <h2 class="font-serif4 font-bold text-2xl mb-4">Housing Violations</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white rounded-lg shadow-md">
          <thead class="bg-gray-100">
            <tr>
              <th class="py-3 px-4 text-left">Violation Number</th>
              <th class="py-3 px-4 text-left">Severity</th>
              <th class="py-3 px-4 text-left">Order</th>
              <th class="py-3 px-4 text-left">Apartment</th>
              <th class="py-3 px-4 text-left">Story</th>
              <th class="py-3 px-4 text-left">Date</th>
              <th class="py-3 px-4 text-left">Description</th>
            </tr>
          </thead>
          <tbody id="violations-table-body">
            <!-- Violations data will be populated here -->
          </tbody>
        </table>
      </div>
      <div id="no-violations" class="hidden bg-gray-50 p-4 text-center rounded mt-4">
        No violations found for this property.
      </div>
    </div>
    
    <div id="complaints-container" class="mb-8">
      <h2 class="font-serif4 font-bold text-2xl mb-4">311 Complaints</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full bg-white rounded-lg shadow-md">
          <thead class="bg-gray-100">
            <tr>
              <th class="py-3 px-4 text-left">Sr Number</th>
              <th class="py-3 px-4 text-left">Date</th>
              <th class="py-3 px-4 text-left">Complaint Id</th>
              <th class="py-3 px-4 text-left">Apt</th>
              <th class="py-3 px-4 text-left">Description</th>
              <th class="py-3 px-4 text-left">Complaint Detail</th>
              <th class="py-3 px-4 text-left">Location</th>
              <th class="py-3 px-4 text-left">Status</th>
              <th class="py-3 px-4 text-left">Complaint Number</th>
            </tr>
          </thead>
          <tbody id="complaints-table-body">
            <!-- Complaints data will be populated here -->
          </tbody>
        </table>
      </div>
      <div id="no-complaints" class="hidden bg-gray-50 p-4 text-center rounded mt-4">
        No complaints found for this property.
      </div>
    </div>
  </div>
  
  <div id="error-message" class="hidden bg-red-100 text-red-700 p-4 rounded-lg">
    Error message will appear here
  </div>

  {% if page.how_to_use %}
    <div class="rich-text mb-8 mt-12">
      <h2 class="font-serif4 font-bold text-3xl mb-4">How to Use</h2>
      {{ page.how_to_use|richtext }}
    </div>
  {% endif %}
  
  {% if page.data_faqs %}
    <div class="rich-text mb-8">
      <h2 class="font-serif4 font-bold text-3xl mb-4">Data FAQs</h2>
      {{ page.data_faqs|richtext }}
    </div>
  {% endif %}
</div>

<script>
document.getElementById("hpd-lookup-form").addEventListener("submit", async function(e) {
  e.preventDefault();
  
  const address = document.getElementById("address").value.trim();
  const zipCode = document.getElementById("zip-code").value.trim();
  const loadingIndicator = document.getElementById("loading-indicator");
  const resultsContainer = document.getElementById("results-container");
  const errorDiv = document.getElementById("error-message");
  
  // Hide previous results and errors, show loading
  resultsContainer.classList.add("hidden");
  errorDiv.classList.add("hidden");
  loadingIndicator.classList.remove("hidden");
  
  try {
    const res = await fetch(`/scrape-hpd/?address=${encodeURIComponent(address)}&zip_code=${encodeURIComponent(zipCode)}`, {
      headers: {"X-Requested-With": "XMLHttpRequest"}
    });
    
    const data = await res.json();
    
    loadingIndicator.classList.add("hidden");
    
    if (data.success) {
      // Show results container
      resultsContainer.classList.remove("hidden");
      
      // Populate property info
      const propertyDetails = document.getElementById("property-details");
      propertyDetails.innerHTML = `
        <div><strong>Address:</strong> ${data.data.metadata.address}</div>
        <div><strong>ZIP Code:</strong> ${data.data.metadata.zip_code}</div>
        <div><strong>Borough:</strong> ${data.data.metadata.borough}</div>
      `;
      
      // Populate violations table
      const violationsBody = document.getElementById("violations-table-body");
      const noViolations = document.getElementById("no-violations");
      
      if (data.data.violations && data.data.violations.length > 0) {
        // Clear existing rows
        violationsBody.innerHTML = '';
        
        // Create data rows using the static column structure
        data.data.violations.forEach(violation => {
          const row = document.createElement('tr');
          row.className = "border-b";
          
          // Map fields exactly as they appear in the column headers
          row.innerHTML = `
            <td class="py-3 px-4">${violation.violation_number || ''}</td>
            <td class="py-3 px-4">${violation.severity || ''}</td>
            <td class="py-3 px-4">${violation.order || ''}</td>
            <td class="py-3 px-4">${violation.apartment || ''}</td>
            <td class="py-3 px-4">${violation.story || ''}</td>
            <td class="py-3 px-4">${violation.date || ''}</td>
            <td class="py-3 px-4">${violation.description || ''}</td>
          `;
          
          violationsBody.appendChild(row);
        });
        
        violationsBody.closest('table').classList.remove("hidden");
        noViolations.classList.add("hidden");
      } else {
        violationsBody.innerHTML = '';
        violationsBody.closest('table').classList.add("hidden");
        noViolations.classList.remove("hidden");
      }
      
      // Populate complaints table
      const complaintsBody = document.getElementById("complaints-table-body");
      const noComplaints = document.getElementById("no-complaints");
      
      if (data.data.complaints && data.data.complaints.length > 0) {
        // Clear existing rows
        complaintsBody.innerHTML = '';
        
        // Create data rows using the static column structure
        data.data.complaints.forEach(complaint => {
          const row = document.createElement('tr');
          row.className = "border-b";
          
          // Map fields exactly as they appear in the column headers
          row.innerHTML = `
            <td class="py-3 px-4">${complaint.sr_number || ''}</td>
            <td class="py-3 px-4">${complaint.date || ''}</td>
            <td class="py-3 px-4">${complaint.complaint_id || ''}</td>
            <td class="py-3 px-4">${complaint.apt || ''}</td>
            <td class="py-3 px-4">${complaint.description || ''}</td>
            <td class="py-3 px-4">${complaint.complaint_detail || ''}</td>
            <td class="py-3 px-4">${complaint.location || ''}</td>
            <td class="py-3 px-4">${complaint.status || ''}</td>
            <td class="py-3 px-4">${complaint.complaint_number || ''}</td>
          `;
          
          complaintsBody.appendChild(row);
        });
        
        complaintsBody.closest('table').classList.remove("hidden");
        noComplaints.classList.add("hidden");
      } else {
        complaintsBody.innerHTML = '';
        complaintsBody.closest('table').classList.add("hidden");
        noComplaints.classList.remove("hidden");
      }
      
      // Display message if one exists
      if (data.data.message) {
        const messageElement = document.createElement('div');
        messageElement.className = 'bg-yellow-50 p-4 text-center rounded mt-4 mb-8';
        
        // Special styling for mock data messages
        if (data.data.message.includes("sample data")) {
          messageElement.className = 'bg-blue-50 p-4 text-center rounded mt-4 mb-8';
          messageElement.innerHTML = `
            <p>${data.data.message}</p>
            <p class="text-sm mt-2">HPD data is provided as a demonstration when live connections are unavailable.</p>
          `;
        } else {
          messageElement.textContent = data.data.message;
        }
        
        resultsContainer.insertBefore(messageElement, resultsContainer.firstChild);
      }
      
      // Add debug info section to help troubleshoot
      const debugInfo = document.createElement('div');
      debugInfo.id = 'debug-info';
      debugInfo.className = 'bg-gray-100 p-4 rounded-lg mt-8 text-xs font-mono';
      debugInfo.innerHTML = '<h3 class="font-bold mb-2">Debug Information:</h3>';
      resultsContainer.after(debugInfo);
      
      // Display request/response details for debugging
      debugInfo.innerHTML += `<div>Request URL: /scrape-hpd/?address=${encodeURIComponent(address)}&zip_code=${encodeURIComponent(zipCode)}</div>`;
      debugInfo.innerHTML += `<div>Response Status: ${res.status}</div>`;
      
      // Log the full response for debugging
      console.log("Full API Response:", data);
      debugInfo.innerHTML += `<div>Full Response (see console):</div>`;
      
    } else {
      // Show error
      errorDiv.textContent = data.error || "Failed to retrieve data from HPD Online";
      errorDiv.classList.remove("hidden");
    }
  } catch (error) {
    loadingIndicator.classList.add("hidden");
    errorDiv.textContent = `Error: ${error.message}`;
    errorDiv.classList.remove("hidden");
  }
});
</script>
{% endblock %} 