{% extends "base_page.html" %}
{% load wagtailcore_tags wagtailimages_tags static %}

{% block content %}
  <div class="site-container">
    <h1 class="font-serif4 text-4xl md:text-6xl font-bold mb-4">{{ page.header }}</h1>
    <div class="mb-6">{{ page.instructions|richtext }}</div>
    
    <!-- Lookup Form -->
    <form id="lookup-form" class="mb-6">
      <div class="flex flex-col md:flex-row gap-3">
        <input 
          type="text" 
          id="address" 
          name="address" 
          placeholder="Enter address" 
          required 
          class="form-input p-2 border border-gray-300 rounded w-full md:w-1/2"
        >
        <input 
          type="text" 
          id="zip-code" 
          name="zip_code" 
          placeholder="Enter ZIP code" 
          required 
          class="form-input p-2 border border-gray-300 rounded w-full md:w-1/3"
        >
        <button 
          type="submit" 
          class="btn bg-blue-600 text-white py-2 px-4 rounded hover:bg-blue-700 transition"
        >
          Search
        </button>
      </div>
    </form>
    
    <!-- Results Section -->
    <div id="results"></div>
  </div>

  <script>
    /**
     * Renders a table for a given dataset, excluding any columns listed in excludedCols.
     *
     * @param {Object[]} dataArray - Array of objects representing table rows
     * @param {string} title - Table title
     * @param {string[]} [excludedCols=[]] - Optional list of columns to exclude
     * @returns {string} - HTML markup for the table
     */
    function renderTable(dataArray, title, excludedCols = []) {
      if (!dataArray || !dataArray.length) {
        return `
          <div class="my-4">
            <h2 class="font-serif4 text-2xl md:text-3xl font-semibold mb-2">${title}</h2>
            <p class="text-gray-600">No ${title} data available.</p>
          </div>
        `;
      }
      
      // Determine columns from the keys of the first object, minus excludedCols
      let columns = Object.keys(dataArray[0]);
      columns = columns.filter(col => !excludedCols.includes(col));

      const tableId = title.replace(/\s/g, '_');

      let html = `<div class="my-4">`;
      html += `<h2 class="font-serif4 text-2xl md:text-3xl font-semibold mb-2">${title}</h2>`;
      html += `
        <input
          type="text"
          class="form-input mb-2 p-1 border border-gray-300 rounded w-full sm:w-1/2"
          placeholder="Filter ${title}"
          onkeyup="filterTable(this, '${tableId}')"
        >
      `;
      
      // Outer container with border and rounding
      html += `<div class="overflow-x-auto border border-gray-300 rounded shadow-sm">`;
      
      // Table with collapsed borders, smaller padding
      html += `
        <table id="${tableId}" class="table-auto w-full border-collapse text-sm">
          <thead class="bg-gray-100 border-b border-gray-300">
            <tr>
      `;
      columns.forEach(col => {
        html += `
          <th
            class="px-2 py-1 text-left text-xs font-semibold text-gray-600 uppercase border border-gray-300"
          >
            ${col}
          </th>
        `;
      });
      html += `</tr></thead><tbody>`;

      // Rows with hover effect, smaller cell padding, borders on each cell
      dataArray.forEach(row => {
        html += `<tr class="hover:bg-gray-50 transition">`;
        columns.forEach(col => {
          html += `
            <td
              class="px-2 py-1 border border-gray-300 text-gray-700 whitespace-nowrap"
            >
              ${row[col] !== undefined ? row[col] : ""}
            </td>
          `;
        });
        html += `</tr>`;
      });
      
      html += `</tbody></table></div></div>`;
      return html;
    }

    // Filters table rows based on user input in the filter box
    function filterTable(input, tableId) {
      const filter = input.value.toLowerCase();
      const table = document.getElementById(tableId);
      const rows = table.getElementsByTagName("tr");
      // Skip header row (index 0)
      for (let i = 1; i < rows.length; i++) {
        const rowText = rows[i].textContent.toLowerCase();
        rows[i].style.display = rowText.indexOf(filter) > -1 ? "" : "none";
      }
    }

    // Form submission event: fetch data with the X-Requested-With header
    document.getElementById("lookup-form").addEventListener("submit", async function(event) {
      event.preventDefault();
      const address = document.getElementById("address").value.trim();
      const zipCode = document.getElementById("zip-code").value.trim();
      const resultsDiv = document.getElementById("results");
      
      resultsDiv.innerHTML = "<p class='text-gray-600'>Fetching data...</p>";
      
      try {
        const response = await fetch(`/nyc-lookup-tool/?address=${encodeURIComponent(address)}&zip_code=${encodeURIComponent(zipCode)}`, {
          headers: { "X-Requested-With": "XMLHttpRequest" }
        });
        const data = await response.json();
        
        if (data.success) {
          let html = `
            <h2 class="font-serif4 text-3xl md:text-5xl font-semibold mb-3">Property Information</h2>
            <p class="mb-1"><strong>Address:</strong> ${data.data.address}</p>
            <p class="mb-1"><strong>ZIP Code:</strong> ${data.data.zip_code}</p>
            <p class="mb-4"><strong>Building ID:</strong> ${data.data.building_id || "N/A"}</p>
          `;

          // Render HPD Violations with excluded columns
          const excludedColsForViolations = [
            "housenumber",
            "lowhousenumber",
            "highhousenumber",
            "streetname",
            "streetcode",
            "zip"
          ];
          html += renderTable(data.data.hpd_violations, "HPD Violations", excludedColsForViolations);

          // Render other datasets normally
          html += renderTable(data.data.complaints, "311 Complaints");
          html += renderTable(data.data.bedbug_reports, "Bedbug Reports");
          html += renderTable(data.data.litigation, "Housing Litigation");
          
          resultsDiv.innerHTML = html;
        } else {
          resultsDiv.innerHTML = `<p class="text-red-600">Error: ${data.error}</p>`;
        }
      } catch (error) {
        resultsDiv.innerHTML = `<p class="text-red-600">An error occurred: ${error}</p>`;
      }
    });
  </script>
{% endblock %}
