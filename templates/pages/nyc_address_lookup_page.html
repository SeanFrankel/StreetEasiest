{% extends "base_page.html" %}
{% load wagtailcore_tags wagtailimages_tags static %}

{% block content %}
  {% block breadcrumbs %}
    {% include "navigation/breadcrumbs.html" %}
  {% endblock %}

  <div class="site-padding site-container">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row md:items-center py-20">
      <h1 class="font-serif4 [word-spacing:-6px] font-bold text-6xl lg:text-7xl md:pr-16 lg:pr-20 {% if page.instructions %} md:border-r-[1px] md:basis-2/6 border-grey-200 {% endif %}">
        {{ page.header }}
      </h1>
      {% if page.instructions %}
        <div class="max-w-[636px] rich-text pt-5 md:w-2/3 md:pl-16 lg:pl-20">
          {{ page.instructions|richtext }}
        </div>
      {% endif %}
    </div>

    <!-- HOW TO USE SECTION -->
    {% if page.how_to_use %}
      <div class="rich-text mb-8">
        <h2 class="font-serif4 font-bold text-3xl mb-4">How to Use</h2>
        {{ page.how_to_use|richtext }}
      </div>
    {% endif %}

    <!-- Search Form -->
    <section class="lookup-form pb-20">
      <form id="lookup-form" class="form flex flex-col sm:flex-row items-center gap-4">
        <label for="address" class="sr-only">Enter Address:</label>
        <input
          type="text"
          id="address"
          name="address"
          class="form-input w-full sm:w-auto flex-grow rounded border border-gray-300 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="e.g., 123 Main St"
          required
          aria-label="Enter Address"
        />
        <label for="zip-code" class="sr-only">Enter Zip Code:</label>
        <input
          type="text"
          id="zip-code"
          name="zip_code"
          class="form-input w-full sm:w-auto flex-grow rounded border border-gray-300 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="e.g., 10001"
          required
          aria-label="Enter Zip Code"
        />
        {% include "components/button.html" with title="Search" is_submit=True extra_class="lookup-submit" %}
      </form>
    </section>

    <!-- Results Section -->
    <section id="results" class="lookup-results py-10" aria-live="polite" aria-busy="false">
      <p>Results will appear here after searching.</p>
    </section>

    <!-- DATA FAQS SECTION -->
    {% if page.data_faqs %}
      <div class="rich-text mt-8">
        <h2 class="font-serif4 font-bold text-3xl mb-4">Data FAQs</h2>
        {{ page.data_faqs|richtext }}
      </div>
    {% endif %}
  </div>

  {% include_block page.body %}

  <script>
    // Helper function to create a dynamic button with your styling.
    function btnTemplate(title, onclickAction) {
      return `<button type="button" onclick="${onclickAction}" class="btn btn-secondary md:px-10 text-white bg-mackerel-300 dark:text-mackerel-400 px-5 py-3 md:py-[15px] justify-center items-center text-sm md:text-base font-codepro uppercase inline-flex rounded-[3px]">${title}</button>`;
    }

    // Global object to track the current number of entries displayed per category.
    const categoryCounts = {};

    // This function builds dynamic buttons HTML for a given category.
    function getDynamicButtonsHTML(category) {
      const btnShowMore = btnTemplate("Show 5 More", `show5More('${category}')`);
      const btnShowAll = btnTemplate("Show All", `loadMore('${category}', 'all')`);
      const btnShowOnly5 = btnTemplate("Only show 5 again", `showOnly5('${category}')`);
      return `<div class="mt-4 flex gap-4">
                ${btnShowMore}
                ${btnShowAll}
                ${btnShowOnly5}
              </div>`;
    }

    // Render the results table for one category.
    function renderCategoryTable(category, entries, total) {
      let headerRow = "";
      let tableRows = "";

      if (category === "rent_stabilized") {
        headerRow = `<tr class="bg-gray-200">
                      <th class="border px-4 py-2">Question</th>
                      <th class="border px-4 py-2">Answer</th>
                    </tr>`;
        const entry = entries[0] || {};
        tableRows = `
          <tr>
            <td class="border px-4 py-2">Does your building have rent stabilized units in it?</td>
            <td class="border px-4 py-2">${entry.has_rent_stabilized || "N/A"}</td>
          </tr>
          <tr>
            <td class="border px-4 py-2">If yes, what is the building officially defined as?</td>
            <td class="border px-4 py-2">${entry.official_definition || "N/A"}</td>
          </tr>
          <tr>
            <td class="border px-4 py-2">If yes, what tax abatement does it have?</td>
            <td class="border px-4 py-2">${entry.tax_abatement || "N/A"}</td>
          </tr>
        `;
        return `
          <div class="result-category mb-8" data-category="${category}">
            <h3 class="text-xl font-semibold mb-4">Rent Stabilized Lookup</h3>
            <table class="table-auto w-full border-collapse border border-gray-300">
              <thead>
                ${headerRow}
              </thead>
              <tbody>
                ${tableRows}
              </tbody>
            </table>
          </div>
        `;
      }

      if (category === "housing_violations") {
        headerRow = `<tr class="bg-gray-200">
                      <th class="border px-4 py-2">Type</th>
                      <th class="border px-4 py-2">Description</th>
                      <th class="border px-4 py-2">Date</th>
                      <th class="border px-4 py-2">Current Status</th>
                      <th class="border px-4 py-2">Issue still outstanding</th>
                      <th class="border px-4 py-2">Is the Violation Rent-Impariring?</th>
                    </tr>`;
        tableRows = entries.map(item => {
          return `<tr>
            <td class="border px-4 py-2">${item.type}</td>
            <td class="border px-4 py-2">${item.description || "No description"}</td>
            <td class="border px-4 py-2">${item.date || "No date"}</td>
            <td class="border px-4 py-2">${item["Current Status"] || "Unknown"}</td>
            <td class="border px-4 py-2">${item["Issue still outstanding"] || "No resolution"}</td>
            <td class="border px-4 py-2">${item["Is the Violation Rent-Impariring?"] || "Unknown"}</td>
          </tr>`;
        }).join("");
      } else {
        const displayStatus = (category === "311_complaints");
        headerRow = `<tr class="bg-gray-200">
                        <th class="border px-4 py-2">Type</th>
                        <th class="border px-4 py-2">Description</th>
                        <th class="border px-4 py-2">Date</th>
                        <th class="border px-4 py-2">Resolution</th>
                        ${displayStatus ? `<th class="border px-4 py-2">Status</th>` : ""}
                      </tr>`;
        tableRows = entries.map(item => {
          return `<tr>
            <td class="border px-4 py-2">${item.type}</td>
            <td class="border px-4 py-2">${item.description || "No description"}</td>
            <td class="border px-4 py-2">${item.date || "No date"}</td>
            <td class="border px-4 py-2">${item.resolution_description || "No resolution"}</td>
            ${displayStatus ? `<td class="border px-4 py-2">${item.status || "Unknown"}</td>` : ""}
          </tr>`;
        }).join("");
      }

      const buttonsHTML = getDynamicButtonsHTML(category);

      return `
        <div class="result-category mb-8" data-category="${category}">
          <h3 class="text-xl font-semibold mb-4">${category.replace(/_/g, " ")}</h3>
          <input type="text" placeholder="Filter results..." 
            oninput="filterTable(this, '${category}')" 
            class="mb-4 p-2 border rounded w-full" />
          <table class="table-auto w-full border-collapse border border-gray-300">
            <thead>
              ${headerRow}
            </thead>
            <tbody>
              ${tableRows}
            </tbody>
          </table>
          ${buttonsHTML}
        </div>
      `;
    }

    function filterTable(input, category) {
      const filterText = input.value.toLowerCase();
      const table = document.querySelector(`.result-category[data-category="${category}"] table`);
      if (!table) return;
      const rows = table.querySelectorAll("tbody tr");
      rows.forEach(row => {
        const rowText = row.textContent.toLowerCase();
        row.style.display = rowText.indexOf(filterText) > -1 ? "" : "none";
      });
    }

    async function loadMore(category, count) {
      const addressInput = document.getElementById("address").value.trim();
      const zipCodeInput = document.getElementById("zip-code").value.trim();
      const categoryDiv = document.querySelector(`.result-category[data-category="${category}"]`);
      if (categoryDiv) {
        categoryDiv.innerHTML = '<p class="text-center py-4">Loading...</p>';
      }
      try {
        const requestUrl = `${window.location.pathname}?address=${encodeURIComponent(addressInput)}&zip_code=${encodeURIComponent(zipCodeInput)}&category=${category}&count=${count}`;
        const response = await fetch(requestUrl, { headers: { "X-Requested-With": "XMLHttpRequest" } });
        const data = await response.json();
        if (data.success && data.data[category]) {
          categoryCounts[category] = data.data[category].entries.length;
          const updatedTable = renderCategoryTable(category, data.data[category].entries, data.data[category].total);
          const categoryDiv = document.querySelector(`.result-category[data-category="${category}"]`);
          if (categoryDiv) {
            categoryDiv.outerHTML = updatedTable;
          }
        }
      } catch (error) {
        console.error("Error loading more entries:", error);
      }
    }

    function show5More(category) {
      const current = categoryCounts[category] || 5;
      const newCount = current + 5;
      loadMore(category, newCount);
    }

    function showOnly5(category) {
      loadMore(category, 5);
    }

    document.getElementById("lookup-form").addEventListener("submit", async function (e) {
      e.preventDefault();
      const addressInput = document.getElementById("address").value.trim();
      const zipCodeInput = document.getElementById("zip-code").value.trim();
      const resultsDiv = document.getElementById("results");

      if (!addressInput || !zipCodeInput) {
        alert("Please enter both an address and a zip code.");
        return;
      }

      resultsDiv.innerHTML = "<p>Loading...</p>";
      resultsDiv.setAttribute("aria-busy", "true");

      try {
        const requestUrl = `${window.location.pathname}?address=${encodeURIComponent(addressInput)}&zip_code=${encodeURIComponent(zipCodeInput)}`;
        const response = await fetch(requestUrl, { headers: { "X-Requested-With": "XMLHttpRequest" } });
        const data = await response.json();
        if (data.success) {
          resultsDiv.innerHTML = `
            <h2 class="text-2xl font-bold mb-6">Results</h2>
            ${Object.entries(data.data)
              .map(([key, value]) => {
                categoryCounts[key] = value.entries.length;
                return renderCategoryTable(key, value.entries, value.total);
              })
              .join("")}
          `;
        } else {
          resultsDiv.innerHTML = `<p class="text-red-600">Error: ${data.error}</p>`;
        }
      } catch (error) {
        resultsDiv.innerHTML = `<p class="text-red-600">An error occurred: ${error.message}</p>`;
      } finally {
        resultsDiv.setAttribute("aria-busy", "false");
      }
    });
  </script>
{% endblock %}
