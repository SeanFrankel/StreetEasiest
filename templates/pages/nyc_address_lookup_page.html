{% extends "base_page.html" %}
{% load wagtailcore_tags wagtailimages_tags static %}

{% block content %}
    {% block breadcrumbs %}
        {% include "navigation/breadcrumbs.html" %}
    {% endblock %}
    <div class="site-padding site-container">
        
        <!-- Header Section -->
        <div class="flex flex-col md:flex-row md:items-center py-20">
            <h1 class="font-serif4 [word-spacing:-6px] font-bold text-8xl lg:text-10xl
            md:pr-16
            lg:pr-20
            {% if page.instructions %}
                md:border-r-[1px]
                md:basis-2/6
                border-grey-200
            {% endif %}">
                {{ page.header }}
            </h1>
            {% if page.instructions %}
                <div class="
                    max-w-[636px]
                    rich-text
                    pt-5
                    md:w-2/3
                    md:pl-16
                    lg:pl-20
                ">
                    <p>{{ page.instructions|linebreaks }}</p>
                </div>
            {% endif %}
        </div>

        <!-- Search Form -->
        <section class="lookup-form pb-20">
            <form id="lookup-form" class="form flex flex-col sm:flex-row items-center gap-4">
                <label for="address" class="sr-only">Enter Address:</label>
                <input
                    type="text"
                    id="address"
                    name="address"
                    class="form-input w-full sm:w-auto flex-grow"
                    placeholder="e.g., 123 Main St"
                    required
                    aria-label="Enter Address"
                />
                <label for="zip-code" class="sr-only">Enter Zip Code:</label>
                <input
                    type="text"
                    id="zip-code"
                    name="zip_code"
                    class="form-input w-full sm:w-auto flex-grow"
                    placeholder="e.g., 10001"
                    required
                    aria-label="Enter Zip Code"
                />
                <button type="submit" class="btn btn-primary">Search</button>
            </form>
        </section>

        <!-- Results Section -->
        <section id="results" class="lookup-results py-10" aria-live="polite" aria-busy="false">
            <p>Results will appear here after searching.</p>
        </section>
    </div>

<script>
document.getElementById("lookup-form").addEventListener("submit", async function (e) {
    e.preventDefault(); // Prevent form submission

    const addressInput = document.getElementById("address").value.trim();
    const zipCodeInput = document.getElementById("zip-code").value.trim();
    const resultsDiv = document.getElementById("results");

    if (!addressInput || !zipCodeInput) {
        alert("Please enter both an address and a zip code.");
        return;
    }

    // Show loading indicator
    resultsDiv.innerHTML = "<p>Loading...</p>";
    resultsDiv.setAttribute("aria-busy", "true");

    try {
        const requestUrl = `${window.location.pathname}?address=${encodeURIComponent(addressInput)}&zip_code=${encodeURIComponent(zipCodeInput)}`;
        const response = await fetch(requestUrl, {
            headers: { "X-Requested-With": "XMLHttpRequest" },
        });

        const data = await response.json();
        if (data.success) {
            const uniqueLocations = data.unique_locations || [];
            resultsDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-6">Results</h2>
                ${
                    uniqueLocations.length > 0
                        ? `<p class="mb-4"><strong>Building's coordinates:</strong> ${uniqueLocations.join(", ")}</p>`
                        : "<p class='mb-4'><strong>Building's coordinates:</strong> No coordinates available</p>"
                }
                ${Object.entries(data.data)
                    .map(([key, items]) => `
                        <div class="result-category mb-8">
                            <h3 class="text-xl font-semibold mb-4">${key.replace(/_/g, " ")}</h3>
                            ${items
                                .map(item => `
                                    <div class="result-item mb-4 p-4 border border-gray-200 rounded-md">
                                        <strong>${item.type}</strong>: ${item.description || "No description"} (${item.date || "No date"})
                                        ${item.resolution_description ? `<br><em>Resolution:</em> ${item.resolution_description}` : ""}
                                        ${item.status ? `<br><em>Status:</em> ${item.status}` : ""}
                                    </div>
                                `)
                                .join("")}
                        </div>
                    `)
                    .join("")}
            `;
        } else {
            resultsDiv.innerHTML = `<p class="text-red-600">Error: ${data.error}</p>`;
        }
    } catch (error) {
        resultsDiv.innerHTML = `<p class="text-red-600">An error occurred: ${error.message}</p>`;
    } finally {
        resultsDiv.setAttribute("aria-busy", "false");
    }
});
</script>
{% endblock %}
