{% extends "base_page.html" %}
{% load wagtailcore_tags wagtailimages_tags static %}

{% block content %}
    <div class="site-padding site-container">
        <!-- Header Section -->
        <div class="flex flex-col md:flex-row md:items-center py-20">
            <h1 class="font-serif4 [word-spacing:-6px] font-bold text-8xl lg:text-10xl
            md:pr-16 lg:pr-20 {% if page.instructions %} md:border-r-[1px] md:basis-2/6 border-grey-200 {% endif %}">
                {{ page.header }}
            </h1>
            {% if page.instructions %}
                <div class="max-w-[636px] rich-text pt-5 md:w-2/3 md:pl-16 lg:pl-20">
                    <p>{{ page.instructions|linebreaks }}</p>
                </div>
            {% endif %}
        </div>

        <!-- Search Form -->
        <section class="lookup-form pb-20">
            <form id="lookup-form" class="form flex flex-col sm:flex-row items-center gap-4">
                <label for="address" class="sr-only">Enter Address:</label>
                <input
                    type="text"
                    id="address"
                    name="address"
                    class="form-input w-full sm:w-auto flex-grow"
                    placeholder="e.g., 123 Main St"
                    required
                    aria-label="Enter Address"
                />
                <label for="zip-code" class="sr-only">Enter Zip Code:</label>
                <input
                    type="text"
                    id="zip-code"
                    name="zip_code"
                    class="form-input w-full sm:w-auto flex-grow"
                    placeholder="e.g., 10001"
                    required
                    aria-label="Enter Zip Code"
                />
                <button type="submit" class="btn btn-primary">Search</button>
            </form>
        </section>

        <!-- Results Section -->
        <section id="results" class="lookup-results py-10" aria-live="polite" aria-busy="false">
            <p>Results will appear here after searching.</p>
        </section>
    </div>

<script>
document.getElementById("lookup-form").addEventListener("submit", async function (e) {
    e.preventDefault();

    const addressInput = document.getElementById("address").value.trim();
    const zipCodeInput = document.getElementById("zip-code").value.trim();
    const resultsDiv = document.getElementById("results");

    if (!addressInput || !zipCodeInput) {
        alert("Please enter both an address and a zip code.");
        return;
    }

    resultsDiv.innerHTML = "<p>Loading...</p>";
    resultsDiv.setAttribute("aria-busy", "true");

    try {
        const requestUrl = `${window.location.pathname}?address=${encodeURIComponent(addressInput)}&zip_code=${encodeURIComponent(zipCodeInput)}`;
        const response = await fetch(requestUrl, { headers: { "X-Requested-With": "XMLHttpRequest" } });

        const data = await response.json();
        if (data.success) {
            resultsDiv.innerHTML = `
                <h2 class="text-2xl font-bold mb-6">Results</h2>
                ${Object.entries(data.data)
                    .map(([key, value]) => renderCategoryTable(key, value.entries, value.total))
                    .join("")}
            `;
        } else {
            resultsDiv.innerHTML = `<p class="text-red-600">Error: ${data.error}</p>`;
        }
    } catch (error) {
        resultsDiv.innerHTML = `<p class="text-red-600">An error occurred: ${error.message}</p>`;
    } finally {
        resultsDiv.setAttribute("aria-busy", "false");
    }
});

function renderCategoryTable(category, entries, total) {
    const tableRows = entries.map(item => `
        <tr>
            <td class="border px-4 py-2">${item.type}</td>
            <td class="border px-4 py-2">${item.description || "No description"}</td>
            <td class="border px-4 py-2">${item.date || "No date"}</td>
            <td class="border px-4 py-2">${item.resolution_description || "No resolution"}</td>
            <td class="border px-4 py-2">${item.status || "Unknown"}</td>
        </tr>
    `).join("");

    return `
        <div class="result-category mb-8" data-category="${category}">
            <h3 class="text-xl font-semibold mb-4">${category.replace(/_/g, " ")}</h3>
            <table class="table-auto w-full border-collapse border border-gray-300">
                <thead>
                    <tr class="bg-gray-200">
                        <th class="border px-4 py-2">Type</th>
                        <th class="border px-4 py-2">Description</th>
                        <th class="border px-4 py-2">Date</th>
                        <th class="border px-4 py-2">Resolution</th>
                        <th class="border px-4 py-2">Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
            <div class="mt-4 flex gap-4">
                <button class="btn btn-secondary" onclick="loadMore('${category}', 15)">Show 15 More</button>
                <button class="btn btn-secondary" onclick="loadMore('${category}', 'all')">Show All</button>
            </div>
        </div>
    `;
}

async function loadMore(category, count) {
    const addressInput = document.getElementById("address").value.trim();
    const zipCodeInput = document.getElementById("zip-code").value.trim();

    try {
        const requestUrl = `${window.location.pathname}?address=${encodeURIComponent(addressInput)}&zip_code=${encodeURIComponent(zipCodeInput)}&category=${category}&count=${count}`;
        const response = await fetch(requestUrl, { headers: { "X-Requested-With": "XMLHttpRequest" } });

        const data = await response.json();
        if (data.success && data.data[category]) {
            const updatedTable = renderCategoryTable(category, data.data[category].entries, data.data[category].total);
            const categoryDiv = document.querySelector(`.result-category[data-category="${category}"]`);
            if (categoryDiv) {
                categoryDiv.outerHTML = updatedTable;
            }
        }
    } catch (error) {
        console.error("Error loading more entries:", error);
    }
}
</script>
{% endblock %}
