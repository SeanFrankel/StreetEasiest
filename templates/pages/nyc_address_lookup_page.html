{% extends "base_page.html" %}
{% load wagtailcore_tags wagtailimages_tags static %}

{% block content %}
  {% block breadcrumbs %}
    {% include "navigation/breadcrumbs.html" %}
  {% endblock %}

  <div class="site-padding site-container">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row md:items-center py-20">
      <h1 class="font-serif4 [word-spacing:-6px] font-bold text-6xl lg:text-7xl md:pr-16 lg:pr-20 {% if page.instructions %} md:border-r-[1px] md:basis-2/6 border-grey-200 {% endif %}">
        {{ page.header }}
      </h1>
      {% if page.instructions %}
        <div class="max-w-[636px] rich-text pt-5 md:w-2/3 md:pl-16 lg:pl-20">
          {{ page.instructions|richtext }}
        </div>
      {% endif %}
    </div>

    <!-- HOW TO USE SECTION -->
    {% if page.how_to_use %}
      <div class="rich-text mb-8">
        <h2 class="font-serif4 font-bold text-3xl mb-4">How to Use</h2>
        {{ page.how_to_use|richtext }}
      </div>
    {% endif %}

    <!-- Search Form -->
    <section class="lookup-form pb-20">
      <form id="lookup-form" class="form flex flex-col sm:flex-row items-center gap-4">
        <label for="address" class="sr-only">Enter Address:</label>
        <input
          type="text"
          id="address"
          name="address"
          class="form-input w-full sm:w-auto flex-grow rounded border border-gray-300 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="e.g., 123 Main St"
          required
          aria-label="Enter Address"
        />
        <label for="zip-code" class="sr-only">Enter Zip Code:</label>
        <input
          type="text"
          id="zip-code"
          name="zip_code"
          class="form-input w-full sm:w-auto flex-grow rounded border border-gray-300 py-2 px-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
          placeholder="e.g., 10001"
          required
          aria-label="Enter Zip Code"
        />
        {% include "components/button.html" with title="Search" is_submit=True extra_class="lookup-submit" %}
      </form>
    </section>

    <!-- Results Section -->
    <section id="results" class="lookup-results py-10" aria-live="polite" aria-busy="false">
      <p>Results will appear here after searching.</p>
    </section>

    <!-- DATA FAQS SECTION -->
    {% if page.data_faqs %}
      <div class="rich-text mt-8">
        <h2 class="font-serif4 font-bold text-3xl mb-4">Data FAQs</h2>
        {{ page.data_faqs|richtext }}
      </div>
    {% endif %}
  </div>

  {% include_block page.body %}

  <script>
    // Helper function to create a dynamic button with your styling.
    function btnTemplate(title, onclickAction) {
      return `<button type="button" onclick="${onclickAction}" class="btn btn-secondary md:px-10 text-white bg-mackerel-300 dark:text-mackerel-400 px-5 py-3 md:py-[15px] justify-center items-center text-sm md:text-base font-codepro uppercase inline-flex rounded-[3px]">${title}</button>`;
    }

    // Display property information
    function renderPropertyInfo(metadata) {
      return `
        <div class="property-info mb-8 p-6 bg-gray-50 rounded-lg shadow-sm">
          <h3 class="text-xl font-semibold mb-4 border-b pb-2">Property Information</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div><strong>Address:</strong> ${metadata.address || 'N/A'}</div>
            <div><strong>ZIP Code:</strong> ${metadata.zip_code || 'N/A'}</div>
            <div><strong>Borough:</strong> ${metadata.borough || 'N/A'}</div>
            <div><strong>Building ID:</strong> ${metadata.building_id || 'N/A'}</div>
          </div>
          <div class="mt-4 text-sm text-gray-500">
            <p>Data retrieved using the official NYC GeoClient API.</p>
          </div>
        </div>
      `;
    }
    
    // Render the violations table
    function renderViolationsTable(violations) {
      if (!violations || violations.length === 0) {
        return `
          <div class="mb-8">
            <h3 class="text-xl font-semibold mb-2">Housing Violations</h3>
            <div class="bg-gray-50 p-4 text-center rounded">No housing violations found for this building.</div>
          </div>
        `;
      }
      
      const tableRows = violations.map(violation => {
        let classIndicator = '';
        if (violation.class) {
          const violationClass = violation.class.toLowerCase();
          classIndicator = `<span class="inline-block px-2 py-1 rounded ${
            violationClass === 'a' ? 'bg-red-100 text-red-800' : 
            violationClass === 'b' ? 'bg-blue-100 text-blue-800' : 
            violationClass === 'c' ? 'bg-yellow-100 text-yellow-800' : 
            'bg-gray-100 text-gray-800'
          }">${violation.class}</span>`;
        }
        
        return `
          <tr class="border-b">
            <td class="border px-4 py-2">${violation.violation_number || 'N/A'}</td>
            <td class="border px-4 py-2">${classIndicator}</td>
            <td class="border px-4 py-2">${violation.order || 'N/A'}</td>
            <td class="border px-4 py-2">${violation.apartment || 'N/A'}</td>
            <td class="border px-4 py-2">${violation.story || 'N/A'}</td>
            <td class="border px-4 py-2">${violation.date || 'N/A'}</td>
            <td class="border px-4 py-2 description-cell">${violation.description || 'No description available'}</td>
          </tr>
        `;
      }).join('');
      
      return `
        <div class="violations-section mb-8">
          <h3 class="text-xl font-semibold mb-4">Housing Violations (${violations.length})</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white border">
              <thead>
                <tr class="bg-gray-200">
                  <th class="border px-4 py-2">Violation ID</th>
                  <th class="border px-4 py-2">Class</th>
                  <th class="border px-4 py-2">Order #</th>
                  <th class="border px-4 py-2">Apt #</th>
                  <th class="border px-4 py-2">Story</th>
                  <th class="border px-4 py-2">Date</th>
                  <th class="border px-4 py-2">Description</th>
                </tr>
              </thead>
              <tbody>
                ${tableRows}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }
    
    // Render the 311 complaints table
    function render311ComplaintsTable(complaints) {
      if (!complaints || complaints.length === 0) {
        return `
          <div class="mb-8">
            <h3 class="text-xl font-semibold mb-2">311 Complaints</h3>
            <div class="bg-gray-50 p-4 text-center rounded">No 311 complaints found for this building.</div>
          </div>
        `;
      }
      
      const tableRows = complaints.map(complaint => {
        return `
          <tr class="border-b">
            <td class="border px-4 py-2">${complaint.unique_key || complaint.id || 'N/A'}</td>
            <td class="border px-4 py-2">${complaint.complaint_type || 'N/A'}</td>
            <td class="border px-4 py-2">${complaint.status || 'N/A'}</td>
            <td class="border px-4 py-2">${complaint.created_date || 'N/A'}</td>
            <td class="border px-4 py-2">${complaint.closed_date || 'N/A'}</td>
            <td class="border px-4 py-2 description-cell">${complaint.descriptor || complaint.description || 'No description available'}</td>
          </tr>
        `;
      }).join('');
      
      return `
        <div class="complaints-section mb-8">
          <h3 class="text-xl font-semibold mb-4">311 Complaints (${complaints.length})</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full bg-white border">
              <thead>
                <tr class="bg-gray-200">
                  <th class="border px-4 py-2">Complaint ID</th>
                  <th class="border px-4 py-2">Type</th>
                  <th class="border px-4 py-2">Status</th>
                  <th class="border px-4 py-2">Created Date</th>
                  <th class="border px-4 py-2">Closed Date</th>
                  <th class="border px-4 py-2">Description</th>
                </tr>
              </thead>
              <tbody>
                ${tableRows}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    document.getElementById("lookup-form").addEventListener("submit", async function (e) {
      e.preventDefault();
      const addressInput = document.getElementById("address").value.trim();
      const zipCodeInput = document.getElementById("zip-code").value.trim();
      const resultsDiv = document.getElementById("results");

      if (!addressInput || !zipCodeInput) {
        alert("Please enter both an address and a zip code.");
        return;
      }

      resultsDiv.innerHTML = '<div class="text-center py-8"><div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500"></div><p class="mt-2">Fetching data from NYC Open Data APIs...</p></div>';
      resultsDiv.setAttribute("aria-busy", "true");

      try {
        const requestUrl = `/scrape-hpd/?address=${encodeURIComponent(addressInput)}&zip_code=${encodeURIComponent(zipCodeInput)}`;
        const response = await fetch(requestUrl, { headers: { "X-Requested-With": "XMLHttpRequest" } });
        const responseData = await response.json();
        
        if (responseData.success) {
          const data = responseData.data;
          
          // Build the HTML for the results
          let resultsHTML = '<h2 class="text-2xl font-bold mb-6">Results</h2>';
          
          // Add property information
          if (data.metadata) {
            resultsHTML += renderPropertyInfo(data.metadata);
          }
          
          // Add violations table
          if (data.housing_violations) {
            resultsHTML += renderViolationsTable(data.housing_violations.entries);
          }
          
          // Add 311 complaints table
          if (data["311_complaints"]) {
            resultsHTML += render311ComplaintsTable(data["311_complaints"].entries);
          }
          
          // Add HPD direct links if we have a building ID
          if (data.metadata && data.metadata.building_id) {
            const buildingId = data.metadata.building_id;
            resultsHTML += `
              <div class="hpd-links text-center mb-8">
                <p class="text-sm text-gray-600 mb-2">View more information on official NYC websites:</p>
                <div class="flex flex-wrap justify-center gap-2">
                  <a href="https://hpdonline.nyc.gov/hpdonline/building/${buildingId}" target="_blank" 
                     class="bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200">
                    Building Info
                  </a>
                  <a href="https://hpdonline.nyc.gov/hpdonline/building/${buildingId}/violations" target="_blank"
                     class="bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200">
                    Violations
                  </a>
                  <a href="https://hpdonline.nyc.gov/hpdonline/building/${buildingId}/complaints" target="_blank"
                     class="bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200">
                    Complaints
                  </a>
                  <a href="https://a810-bisweb.nyc.gov/bisweb/PropertyProfileOverviewServlet?bin=${buildingId}" target="_blank"
                     class="bg-blue-100 text-blue-800 px-3 py-1 rounded hover:bg-blue-200">
                    DOB BIS
                  </a>
                </div>
              </div>
            `;
          }
          
          resultsDiv.innerHTML = resultsHTML;
        } else {
          resultsDiv.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded-lg">${responseData.error || "An error occurred while retrieving data."}</div>`;
        }
      } catch (error) {
        resultsDiv.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded-lg">Error: ${error.message}</div>`;
      } finally {
        resultsDiv.setAttribute("aria-busy", "false");
      }
    });
  </script>
{% endblock %}