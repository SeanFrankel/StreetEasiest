{% extends "base.html" %}

{% block content %}
<div class="lookup-page">
    <h1>{{ page.header }}</h1>
    <p>{{ page.instructions }}</p>

    <!-- Search form -->
    <form id="lookup-form">
        <label for="address">Enter Address:</label>
        <input
            type="text"
            id="address"
            name="address"
            placeholder="e.g., 123 Main St"
            required
            aria-label="Enter Address"
        />
        <button type="submit">Search</button>
    </form>

    <!-- Results Section -->
    <section id="results" aria-live="polite">
        <p>Results will appear here after searching.</p>
    </section>
</div>

<script>
document.getElementById("lookup-form").addEventListener("submit", async function (e) {
    e.preventDefault(); // Prevent form submission

    const addressInput = document.getElementById("address").value.trim();
    const resultsDiv = document.getElementById("results");

    if (!addressInput) {
        alert("Please enter an address.");
        return;
    }

    resultsDiv.innerHTML = "<p>Loading...</p>"; // Show loading state

    try {
        const requestUrl = `${window.location.pathname}?address=${encodeURIComponent(addressInput)}`;
        console.log("Request URL:", requestUrl); // Log request URL for debugging

        const response = await fetch(requestUrl, {
            headers: { "X-Requested-With": "XMLHttpRequest" },
        });

        const contentType = response.headers.get("Content-Type");
        if (contentType && contentType.includes("application/json")) {
            const data = await response.json();
            console.log("Response Data:", data); // Log the response data

            if (data.success) {
                // Display results
                resultsDiv.innerHTML = `
                    <h2>Results</h2>
                    ${Object.entries(data.data)
                        .map(([key, items]) => `
                            <div>
                                <h3>${key.replace(/_/g, " ")}</h3>
                                ${items
                                    .map(item => `
                                        <div>
                                            <strong>${item.type}</strong>: ${item.description || "No description"} (${item.date || "No date"})
                                        </div>
                                    `)
                                    .join("")}
                            </div>
                        `)
                        .join("")}
                `;
            } else {
                resultsDiv.innerHTML = `<p>Error: ${data.error}</p>`;
            }
        } else {
            const text = await response.text();
            console.error("Unexpected Response:", text); // Log unexpected responses
            resultsDiv.innerHTML = `<p>Unexpected response from the server. Check the console for details.</p>`;
        }
    } catch (error) {
        console.error("Error during fetch:", error); // Log fetch errors
        resultsDiv.innerHTML = `<p>An error occurred: ${error.message}</p>`;
    }
});

</script>
{% endblock %}
